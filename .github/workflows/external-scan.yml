name: External Scan

on:
  push:
    branches: ['automation/**']
  workflow_dispatch:

jobs:
  scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Preflight log
        run: |
          mkdir -p logs
          echo "ref=${GITHUB_REF}" > logs/preflight.txt
          echo "sha=${GITHUB_SHA}" >> logs/preflight.txt
          echo "actor=${GITHUB_ACTOR}" >> logs/preflight.txt
          echo "event=${GITHUB_EVENT_NAME}" >> logs/preflight.txt
          echo "targets: ziana-scan.bensalemyassine498.workers.dev" >> logs/preflight.txt
          echo "params: RATE=2, CONCURRENCY=10" >> logs/preflight.txt

      - name: Install tools
        run: |
          sudo apt-get update -y
          sudo apt-get install -y unzip curl
          curl -fsSL https://github.com/projectdiscovery/subfinder/releases/latest/download/subfinder_linux_amd64.zip -o subfinder.zip
          unzip -o subfinder.zip && sudo mv subfinder /usr/local/bin/ && rm subfinder.zip
          curl -fsSL https://github.com/projectdiscovery/httpx/releases/latest/download/httpx_linux_amd64.zip -o httpx.zip
          unzip -o httpx.zip && sudo mv httpx /usr/local/bin/ && rm httpx.zip
          curl -fsSL https://github.com/projectdiscovery/nuclei/releases/latest/download/nuclei_linux_amd64.zip -o nuclei.zip
          unzip -o nuclei.zip && sudo mv nuclei /usr/local/bin/ && rm nuclei.zip

      - name: Verify tools
        run: |
          which subfinder || echo "subfinder not found"
          which httpx || echo "httpx not found"
          which nuclei || echo "nuclei not found"

      - name: Run scan
        run: |
          mkdir -p out_scan
          subfinder -d example.com -silent -o out_scan/subs.txt || echo "subfinder failed"
          httpx -l out_scan/subs.txt -silent -o out_scan/live.txt || echo "httpx failed"
          nuclei -l out_scan/live.txt -silent -o out_scan/report.txt || echo "nuclei failed"

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: logs
          path: logs/

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: scan-results
          path: out_scan/
