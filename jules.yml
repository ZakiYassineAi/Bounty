version: "1.0"

tasks:
  - name: Prepare
    run: |
      mkdir -p out_scan reports logs

  - name: Subfinder
    run: subfinder -d ziana-scan.bensalemyassine498.workers.dev -silent -o out_scan/subs.txt || true

  - name: Httpx
    run: |
      if [ -s out_scan/subs.txt ]; then
        httpx -l out_scan/subs.txt -silent -o out_scan/live.txt || true
      else
        touch out_scan/live.txt
      fi

  - name: Nuclei
    run: |
      if [ -s out_scan/live.txt ]; then
        nuclei -l out_scan/live.txt -severity medium,high,critical -jsonl -o out_scan/report.jsonl || true
      else
        touch out_scan/report.jsonl
      fi

  - name: TSV
    run: |
      python3 - << 'PY'
import json, sys, os
inp = "out_scan/report.jsonl"
outp = "reports/report.tsv"
os.makedirs("reports", exist_ok=True)
if not os.path.exists(inp) or os.stat(inp).st_size == 0:
    open(outp,"w").write("No findings\t-\t-\n")
    sys.exit(0)
lines=[]
with open(inp, "r", encoding="utf-8", errors="ignore") as f:
    for line in f:
        if not line.strip(): continue
        try:
            j=json.loads(line)
            matched=j.get("matched-at","-")
            info=j.get("info",{})
            name=info.get("name","-")
            sev=info.get("severity","-")
            lines.append(f"{matched}\t{name}\t{sev}")
        except Exception:
            continue
open(outp,"w",encoding="utf-8").write("\n".join(lines) if lines else "No findings\t-\t-\n")
PY
